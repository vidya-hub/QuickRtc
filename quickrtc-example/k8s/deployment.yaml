# QuickRTC Server Deployment
# Scalable MediaSoup SFU for video conferencing
apiVersion: apps/v1
kind: Deployment
metadata:
  name: quickrtc-server
  namespace: quickrtc
  labels:
    app: quickrtc
    component: server
spec:
  replicas: 1  # Single replica for Colima single-node (hostNetwork constraint)
  selector:
    matchLabels:
      app: quickrtc
      component: server
  template:
    metadata:
      labels:
        app: quickrtc
        component: server
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    spec:
      # Use host network for WebRTC UDP traffic (required for mediasoup)
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      
      containers:
        - name: quickrtc-server
          image: quickrtc-server:latest
          imagePullPolicy: Never  # Use local image from Colima docker
          
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
            # UDP ports for WebRTC (using hostNetwork)
            
          env:
            - name: NODE_ENV
              valueFrom:
                configMapKeyRef:
                  name: quickrtc-config
                  key: NODE_ENV
            - name: PORT
              valueFrom:
                configMapKeyRef:
                  name: quickrtc-config
                  key: PORT
            - name: USE_SSL
              valueFrom:
                configMapKeyRef:
                  name: quickrtc-config
                  key: USE_SSL
            - name: RTC_MIN_PORT
              valueFrom:
                configMapKeyRef:
                  name: quickrtc-config
                  key: RTC_MIN_PORT
            - name: RTC_MAX_PORT
              valueFrom:
                configMapKeyRef:
                  name: quickrtc-config
                  key: RTC_MAX_PORT
            # Use the node's IP as announced IP for WebRTC
            - name: ANNOUNCED_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
          
          livenessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          readinessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          volumeMounts:
            - name: client-dist
              mountPath: /app/client/dist
              readOnly: true
      
      volumes:
        - name: client-dist
          emptyDir: {}
      
      # Graceful shutdown for WebRTC connections
      terminationGracePeriodSeconds: 30
