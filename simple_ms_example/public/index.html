<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple MediaSoup - Video Conference Example</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header h1 {
        color: white;
        font-size: 1.8rem;
        font-weight: 300;
      }

      .main-container {
        flex: 1;
        display: flex;
        gap: 1rem;
        padding: 1rem;
        max-height: calc(100vh - 80px);
      }

      .video-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: hidden;
      }

      .local-video-section {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .local-video-section h3 {
        color: white;
        margin-bottom: 0.5rem;
        font-weight: 400;
      }

      .local-video {
        width: 100%;
        max-width: 300px;
        height: 200px;
        border-radius: 8px;
        background: #000;
        object-fit: cover;
      }

      .remote-videos-section {
        flex: 1;
        padding: 1rem;
        display: flex;
        flex-direction: column;
      }

      .remote-videos-section h3 {
        color: white;
        margin-bottom: 1rem;
        font-weight: 400;
      }

      .remote-videos {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        flex: 1;
        overflow-y: auto;
      }

      .remote-video {
        width: 100%;
        height: 180px;
        border-radius: 8px;
        background: #000;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .sidebar {
        width: 350px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .control-panel,
      .connection-panel,
      .participants-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 1.5rem;
      }

      .panel-title {
        color: white;
        font-size: 1.2rem;
        font-weight: 400;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 0.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        color: white;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      .form-group input {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 0.9rem;
      }

      .form-group input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
        background: rgba(255, 255, 255, 0.15);
      }

      .button {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        margin: 0.25rem;
      }

      .button-primary {
        background: #667eea;
        color: white;
      }

      .button-primary:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
      }

      .button-secondary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .button-secondary:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .button-danger {
        background: #e74c3c;
        color: white;
      }

      .button-danger:hover {
        background: #c0392b;
      }

      .button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .status {
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }

      .status.connected {
        background: rgba(39, 174, 96, 0.2);
        color: #2ecc71;
        border: 1px solid rgba(39, 174, 96, 0.3);
      }

      .status.disconnected {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.3);
      }

      .status.connecting {
        background: rgba(241, 196, 15, 0.2);
        color: #f1c40f;
        border: 1px solid rgba(241, 196, 15, 0.3);
      }

      .participants-list {
        max-height: 200px;
        overflow-y: auto;
      }

      .participant {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        color: white;
        font-size: 0.9rem;
      }

      .participant.local {
        border-left: 3px solid #667eea;
      }

      .participant.remote {
        border-left: 3px solid #2ecc71;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .media-controls {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .logs {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 6px;
        padding: 1rem;
        max-height: 150px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.8rem;
        color: #ccc;
        margin-top: 1rem;
      }

      .log-entry {
        margin-bottom: 0.25rem;
      }

      .log-entry.info {
        color: #3498db;
      }
      .log-entry.success {
        color: #2ecc71;
      }
      .log-entry.warning {
        color: #f39c12;
      }
      .log-entry.error {
        color: #e74c3c;
      }

      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
        }

        .remote-videos {
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üöÄ Simple MediaSoup - Video Conference Demo</h1>
    </div>

    <div class="main-container">
      <div class="video-container">
        <div class="local-video-section">
          <h3>üìπ Your Video</h3>
          <video
            id="localVideo"
            class="local-video"
            autoplay
            muted
            playsinline
          ></video>
        </div>

        <div class="remote-videos-section">
          <h3>üë• Participants</h3>
          <div id="remoteVideos" class="remote-videos">
            <!-- Remote videos will be added here dynamically -->
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="connection-panel">
          <h3 class="panel-title">üîó Connection</h3>

          <div id="statusIndicator" class="status disconnected">
            ‚ùå Disconnected
          </div>

          <div class="form-group">
            <label for="conferenceId">Conference Room</label>
            <input
              type="text"
              id="conferenceId"
              placeholder="Enter room name (e.g., my-meeting)"
              value="demo-room"
            />
          </div>

          <div class="form-group">
            <label for="participantName">Your Name</label>
            <input
              type="text"
              id="participantName"
              placeholder="Enter your name"
              value="Anonymous"
            />
          </div>

          <div class="controls">
            <button id="connectBtn" class="button button-primary">
              Connect
            </button>
            <button id="disconnectBtn" class="button button-danger" disabled>
              Disconnect
            </button>
          </div>
        </div>

        <div class="control-panel">
          <h3 class="panel-title">üéõÔ∏è Media Controls</h3>

          <div class="media-controls">
            <button
              id="toggleAudioBtn"
              class="button button-secondary"
              disabled
            >
              üé§ Mute Audio
            </button>
            <button
              id="toggleVideoBtn"
              class="button button-secondary"
              disabled
            >
              üìπ Mute Video
            </button>
          </div>

          <div class="controls">
            <button
              id="screenShareBtn"
              class="button button-secondary"
              disabled
            >
              üñ•Ô∏è Share Screen
            </button>
          </div>
        </div>

        <div class="participants-panel">
          <h3 class="panel-title">üë• Participants</h3>
          <div id="participantsList" class="participants-list">
            <!-- Participants will be listed here -->
          </div>
        </div>

        <div class="logs" id="logs">
          <div class="log-entry info">
            üìù Application logs will appear here...
          </div>
        </div>
      </div>
    </div>

    <!-- Load Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Load Simple MediaSoup Client -->
    <script type="module">
      // Import the client library - in production, this would be from CDN or npm build
      import { SimpleClient } from "../simple_ms_client/dist/client.js";

      // Application state
      let client = null;
      let isConnected = false;
      let isAudioMuted = false;
      let isVideoMuted = false;

      // DOM elements
      const elements = {
        // Connection
        statusIndicator: document.getElementById("statusIndicator"),
        conferenceId: document.getElementById("conferenceId"),
        participantName: document.getElementById("participantName"),
        connectBtn: document.getElementById("connectBtn"),
        disconnectBtn: document.getElementById("disconnectBtn"),

        // Media controls
        toggleAudioBtn: document.getElementById("toggleAudioBtn"),
        toggleVideoBtn: document.getElementById("toggleVideoBtn"),
        screenShareBtn: document.getElementById("screenShareBtn"),

        // Videos
        localVideo: document.getElementById("localVideo"),
        remoteVideos: document.getElementById("remoteVideos"),

        // Participants
        participantsList: document.getElementById("participantsList"),

        // Logs
        logs: document.getElementById("logs"),
      };

      // Logging function
      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        elements.logs.appendChild(logEntry);
        elements.logs.scrollTop = elements.logs.scrollHeight;

        // Keep only last 50 log entries
        while (elements.logs.children.length > 50) {
          elements.logs.removeChild(elements.logs.firstChild);
        }
      }

      // Update status indicator
      function updateStatus(status, message) {
        elements.statusIndicator.className = `status ${status}`;
        const icons = {
          connected: "‚úÖ",
          disconnected: "‚ùå",
          connecting: "üîÑ",
        };
        elements.statusIndicator.textContent = `${icons[status]} ${message}`;
      }

      // Update UI based on connection state
      function updateUI() {
        elements.connectBtn.disabled = isConnected;
        elements.disconnectBtn.disabled = !isConnected;
        elements.toggleAudioBtn.disabled = !isConnected;
        elements.toggleVideoBtn.disabled = !isConnected;
        elements.screenShareBtn.disabled = !isConnected;
        elements.conferenceId.disabled = isConnected;
        elements.participantName.disabled = isConnected;
      }

      // Update participants list
      function updateParticipantsList() {
        if (!client) return;

        const participants = client.getParticipants();
        elements.participantsList.innerHTML = "";

        participants.forEach((participant) => {
          const div = document.createElement("div");
          div.className = `participant ${
            participant.isLocal ? "local" : "remote"
          }`;
          div.textContent = `${participant.isLocal ? "üë§" : "üë•"} ${
            participant.name
          }${participant.isLocal ? " (You)" : ""}`;
          elements.participantsList.appendChild(div);
        });
      }

      // Setup event listeners
      function setupEventListeners() {
        if (!client) return;

        // Connection events
        client.on("connected", (event) => {
          const { connection } = event.detail;
          log(`Connected to conference: ${connection.conferenceId}`, "success");
          updateStatus("connected", `Connected to ${connection.conferenceId}`);
          isConnected = true;
          updateUI();
          updateParticipantsList();
        });

        client.on("disconnected", (event) => {
          log("Disconnected from conference", "warning");
          updateStatus("disconnected", "Disconnected");
          isConnected = false;
          updateUI();
          elements.participantsList.innerHTML = "";
          elements.remoteVideos.innerHTML = "";
          elements.localVideo.srcObject = null;
        });

        client.on("error", (event) => {
          const { error, code } = event.detail;
          log(`Error (${code}): ${error.message}`, "error");
        });

        // Participant events
        client.on("participantJoined", (event) => {
          const { participant } = event.detail;
          log(`${participant.name} joined the conference`, "success");
          updateParticipantsList();
        });

        client.on("participantLeft", (event) => {
          const { participant } = event.detail;
          log(`${participant.name} left the conference`, "warning");
          updateParticipantsList();
        });

        // Media events
        client.on("localStreamReady", (event) => {
          const { stream } = event.detail;
          elements.localVideo.srcObject = stream;
          log("Local video stream ready", "success");
        });

        client.on("remoteStreamAdded", (event) => {
          const { stream } = event.detail;
          log(
            `Remote stream added from participant ${stream.participantId}`,
            "success"
          );

          const video = document.createElement("video");
          video.id = `remote-${stream.streamId}`;
          video.className = "remote-video";
          video.srcObject = stream.stream;
          video.autoplay = true;
          video.playsinline = true;

          elements.remoteVideos.appendChild(video);
        });

        client.on("remoteStreamRemoved", (event) => {
          const { streamId, participantId } = event.detail;
          log(
            `Remote stream removed from participant ${participantId}`,
            "warning"
          );

          const video = document.getElementById(`remote-${streamId}`);
          if (video) {
            video.remove();
          }
        });

        // Audio/Video state events
        client.on("audioMuted", (event) => {
          const { participantId, isLocal } = event.detail;
          if (isLocal) {
            elements.toggleAudioBtn.textContent = "üîá Unmute Audio";
            isAudioMuted = true;
          }
          log(
            `Audio muted ${isLocal ? "(You)" : `by ${participantId}`}`,
            "info"
          );
        });

        client.on("audioUnmuted", (event) => {
          const { participantId, isLocal } = event.detail;
          if (isLocal) {
            elements.toggleAudioBtn.textContent = "üé§ Mute Audio";
            isAudioMuted = false;
          }
          log(
            `Audio unmuted ${isLocal ? "(You)" : `by ${participantId}`}`,
            "info"
          );
        });

        client.on("videoMuted", (event) => {
          const { participantId, isLocal } = event.detail;
          if (isLocal) {
            elements.toggleVideoBtn.textContent = "üìπ Unmute Video";
            isVideoMuted = true;
          }
          log(
            `Video muted ${isLocal ? "(You)" : `by ${participantId}`}`,
            "info"
          );
        });

        client.on("videoUnmuted", (event) => {
          const { participantId, isLocal } = event.detail;
          if (isLocal) {
            elements.toggleVideoBtn.textContent = "üìµ Mute Video";
            isVideoMuted = false;
          }
          log(
            `Video unmuted ${isLocal ? "(You)" : `by ${participantId}`}`,
            "info"
          );
        });

        // Screen sharing events
        client.on("screenShareStarted", (event) => {
          const { participantId } = event.detail;
          log(`Screen sharing started by ${participantId}`, "info");
        });

        client.on("screenShareStopped", (event) => {
          const { participantId } = event.detail;
          log(`Screen sharing stopped by ${participantId}`, "info");
        });
      }

      // Connect to conference
      async function connect() {
        const conferenceId = elements.conferenceId.value.trim();
        const participantName = elements.participantName.value.trim();

        if (!conferenceId || !participantName) {
          log("Please enter both conference room and your name", "error");
          return;
        }

        try {
          updateStatus("connecting", "Connecting...");
          log("Connecting to conference...", "info");

          // Create new client instance
          client = new SimpleClient({
            serverUrl: window.location.origin,
            enableAudio: true,
            enableVideo: true,
            autoConsume: true,
          });

          // Setup event listeners
          setupEventListeners();

          // Connect to conference
          await client.connect(conferenceId, participantName);

          log("Successfully connected to conference", "success");
        } catch (error) {
          log(`Failed to connect: ${error.message}`, "error");
          updateStatus("disconnected", "Connection failed");
          client = null;
        }
      }

      // Disconnect from conference
      async function disconnect() {
        if (!client) return;

        try {
          log("Disconnecting from conference...", "info");
          await client.disconnect();
          client = null;
        } catch (error) {
          log(`Error disconnecting: ${error.message}`, "error");
        }
      }

      // Toggle audio
      async function toggleAudio() {
        if (!client) return;

        try {
          const muted = await client.toggleAudio();
          log(`Audio ${muted ? "muted" : "unmuted"}`, "info");
        } catch (error) {
          log(`Failed to toggle audio: ${error.message}`, "error");
        }
      }

      // Toggle video
      async function toggleVideo() {
        if (!client) return;

        try {
          const muted = await client.toggleVideo();
          log(`Video ${muted ? "muted" : "unmuted"}`, "info");
        } catch (error) {
          log(`Failed to toggle video: ${error.message}`, "error");
        }
      }

      // Start screen share
      async function startScreenShare() {
        if (!client) return;

        try {
          const stream = await client.startScreenShare();
          if (stream) {
            log("Screen sharing started", "success");
          }
        } catch (error) {
          log(`Failed to start screen share: ${error.message}`, "error");
        }
      }

      // Bind event listeners
      elements.connectBtn.addEventListener("click", connect);
      elements.disconnectBtn.addEventListener("click", disconnect);
      elements.toggleAudioBtn.addEventListener("click", toggleAudio);
      elements.toggleVideoBtn.addEventListener("click", toggleVideo);
      elements.screenShareBtn.addEventListener("click", startScreenShare);

      // Allow Enter key to connect
      elements.conferenceId.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !isConnected) connect();
      });
      elements.participantName.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !isConnected) connect();
      });

      // Initialize UI
      updateUI();
      log("Simple MediaSoup client loaded successfully", "success");
      log(
        "Enter a conference room name and your name, then click Connect",
        "info"
      );
    </script>
  </body>
</html>
